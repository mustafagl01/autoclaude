/**\n * Call Details Page\n * UK Takeaway Phone Order Assistant Dashboard\n *\n * Displays detailed information for a specific phone call including:\n * - Call metadata (date, duration, phone, outcome)\n * - Full conversation transcript with speaker labels\n * - Audio recording playback (if available)\n * - Order details extracted from conversation\n *\n * Protected route requiring authentication.\n *\n * @see https://nextjs.org/docs/app/building-your-application/rendering/server-components\n * @see /lib/db.ts - Database query functions\n * @see /lib/retell.ts - Retell SDK client wrapper\n */\n\nimport { auth } from '@/app/api/auth/[...nextauth]/route';\nimport { redirect } from 'next/navigation';\n\nimport { getCallById, type Call } from '@/lib/db';\nimport { getCallDetails, type RetellCallDetails } from '@/lib/retell';\nimport Link from 'next/link';\n\n// ============================================================================\n// Type Definitions\n// ============================================================================\n\n/**\n * Call metadata for display\n */\ninterface CallMetadata {\n  id: string;\n  phone_number: string;\n  call_date: string;\n  duration: number | null;\n  status: string;\n  outcome: string | null;\n  recording_url: string | null;\n}\n\n/**\n * Transcript segment with speaker label\n */\ninterface TranscriptSegment {\n  speaker: 'agent' | 'customer';\n  text: string;\n  timestamp?: string;\n}\n\n/**\n * Order details extracted from call\n */\ninterface OrderDetails {\n  customer_name?: string;\n  order_items?: Array<{\n    name: string;\n    quantity: number;\n    price?: number;\n  }>;\n  total_amount?: number;\n  notes?: string;\n}\n\n// ============================================================================\n// Server Component - Call Details Page\n// ============================================================================\n\n/**\n * Call Details Page Component\n *\n * Server component that fetches and displays detailed information for a specific phone call.\n * Requires authenticated session via NextAuth.js.\n *\n * Data fetching strategy:\n * 1. First, try to get call from Postgres cache (for performance)\n * 2. If not found or missing transcript, fetch from Retell API\n * 3. Merge data from both sources for complete information\n *\n * Features:\n * - Server-side data fetching with authentication check\n * - Call metadata display with formatted dates and durations\n * - Full transcript with speaker labels and timestamps\n * - Audio player for call recording (if available)\n * - Order details extraction from conversation\n * - Back button to return to call list\n * - Dark mode support\n * - Responsive design\n *\n * @param props - Page props containing dynamic route parameter (call ID)\n * @returns Call details page JSX or redirects to login\n *\n * @example\n * // Access at http://localhost:3000/dashboard/calls/call_abc123\n * // Requires valid authentication session\n */\nexport default async function CallDetailsPage({\n  params,\n}: {\n  params: { id: string };\n}) {\n  // Get current session (authentication check)\n  const session = await auth();\n\n  // Redirect unauthenticated users to login\n  if (!session || !session.user?.id) {\n    redirect('/login');\n  }\n\n  const callId = params.id;\n\n  // Fetch call from Postgres cache first\n  const cachedCall = await getCallById(callId);\n\n  // Fetch full details from Retell API (for transcript and metadata)\n  let retellCallDetails: RetellCallDetails | null = null;\n  let transcriptError: string | null = null;\n\n  try {\n    const result = await getCallDetails(callId);\n    if (result.success && result.data) {\n      retellCallDetails = result.data;\n    } else {\n      transcriptError = result.error || 'Failed to fetch call details from Retell';\n    }\n  } catch (error) {\n    transcriptError = error instanceof Error ? error.message : 'Unknown error fetching call details';\n  }\n\n  // Merge data: prioritize Retell data for transcript, use cached data for basic info\n  const callMetadata: CallMetadata = {\n    id: callId,\n    phone_number: retellCallDetails?.phone_number || cachedCall?.phone_number || 'Unknown',\n    call_date: retellCallDetails?.start_time || cachedCall?.call_date || new Date().toISOString(),\n    duration: retellCallDetails?.duration || cachedCall?.duration || null,\n    status: retellCallDetails?.status || cachedCall?.status || 'unknown',\n    outcome: retellCallDetails?.outcome || cachedCall?.outcome || null,\n    recording_url: retellCallDetails?.recording_url || null,\n  };\n\n  // Parse transcript segments\n  const transcriptSegments: TranscriptSegment[] = retellCallDetails?.transcript_segments || [];\n\n  // If no segments but we have transcript text, create a single segment\n  const hasTranscriptText = retellCallDetails?.transcript || cachedCall?.transcript;\n  if (transcriptSegments.length === 0 && hasTranscriptText) {\n    const fullTranscript = retellCallDetails?.transcript || cachedCall?.transcript || '';\n    // Try to parse transcript if it has speaker labels\n    const parsedSegments = parseTranscript(fullTranscript);\n    transcriptSegments.push(...parsedSegments);\n  }\n\n  // Extract order details\n  const orderDetails: OrderDetails = retellCallDetails?.metadata || {};\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900\">\n      <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\n        {/* Page Header with Back Button */}\n        <div className=\"mb-8\">\n          <Link\n            href=\"/dashboard/calls\"\n            className=\"inline-flex items-center text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white mb-4 transition-colors\"\n          >\n            <svg\n              className=\"w-4 h-4 mr-2\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              viewBox=\"0 0 24 24\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                strokeWidth={2}\n                d=\"M15 19l-7-7 7-7\"\n              />\n            </svg>\n            Back to Calls\n          </Link>\n          <h1 className=\"text-3xl font-bold text-gray-900 dark:text-white\">\n            Call Details\n          </h1>\n          <p className=\"mt-2 text-gray-600 dark:text-gray-400\">\n            View full transcript and metadata for this phone call\n          </p>\n        </div>\n\n        {/* Error State */}\n        {transcriptError && (\n          <div className=\"mb-6 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4\">\n            <div className=\"flex\">\n              <svg\n                className=\"w-5 h-5 text-yellow-400 mr-2 flex-shrink-0\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                viewBox=\"0 0 24 24\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  strokeWidth={2}\n                  d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\"\n                />\n              </svg>\n              <div className=\"flex-1\">\n                <p className=\"text-sm text-yellow-800 dark:text-yellow-200\">\n                  Some information could not be loaded: {transcriptError}\n                </p>\n              </div>\n            </div>\n          </div>\n        )}\n\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n          {/* Left Column - Metadata and Audio */}\n          <div className=\"lg:col-span-1 space-y-6\">\n            {/* Call Metadata Card */}\n            <div className=\"bg-white dark:bg-gray-800 rounded-lg shadow-md p-6\">\n              <h2 className=\"text-lg font-semibold text-gray-900 dark:text-white mb-4\">\n                Call Information\n              </h2>\n              <dl className=\"space-y-4\">\n                <div>\n                  <dt className=\"text-sm font-medium text-gray-500 dark:text-gray-400\">\n                    Phone Number\n                  </dt>\n                  <dd className=\"mt-1 text-sm text-gray-900 dark:text-white\">\n                    {callMetadata.phone_number}\n                  </dd>\n                </div>\n                <div>\n                  <dt className=\"text-sm font-medium text-gray-500 dark:text-gray-400\">\n                    Date & Time\n                  </dt>\n                  <dd className=\"mt-1 text-sm text-gray-900 dark:text-white\">\n                    {formatDateTime(callMetadata.call_date)}\n                  </dd>\n                </div>\n                <div>\n                  <dt className=\"text-sm font-medium text-gray-500 dark:text-gray-400\">\n                    Duration\n                  </dt>\n                  <dd className=\"mt-1 text-sm text-gray-900 dark:text-white\">\n                    {callMetadata.duration ? formatDuration(callMetadata.duration) : 'N/A'}\n                  </dd>\n                </div>\n                <div>\n                  <dt className=\"text-sm font-medium text-gray-500 dark:text-gray-400\">\n                    Status\n                  </dt>\n                  <dd className=\"mt-1\">\n                    <StatusBadge status={callMetadata.status} />\n                  </dd>\n                </div>\n                {callMetadata.outcome && (\n                  <div>\n                    <dt className=\"text-sm font-medium text-gray-500 dark:text-gray-400\">\n                      Outcome\n                    </dt>\n                    <dd className=\"mt-1 text-sm text-gray-900 dark:text-white\">\n                      {callMetadata.outcome.replace('_', ' ')}\n                    </dd>\n                  </div>\n                )}\n              </dl>\n            </div>\n\n            {/* Audio Player Card */}\n            {callMetadata.recording_url && (\n              <div className=\"bg-white dark:bg-gray-800 rounded-lg shadow-md p-6\">\n                <h2 className=\"text-lg font-semibold text-gray-900 dark:text-white mb-4\">\n                  Call Recording\n                </h2>\n                <audio\n                  controls\n                  className=\"w-full\"\n                  preload=\"metadata\"\n                >\n                  <source src={callMetadata.recording_url} type=\"audio/mpeg\" />\n                  Your browser does not support the audio element.\n                </audio>\n              </div>\n            )}\n\n            {/* Order Details Card (if available) */}\n            {(orderDetails.customer_name ||\n              (orderDetails.order_items && orderDetails.order_items.length > 0) ||\n              orderDetails.total_amount) && (\n              <div className=\"bg-white dark:bg-gray-800 rounded-lg shadow-md p-6\">\n                <h2 className=\"text-lg font-semibold text-gray-900 dark:text-white mb-4\">\n                  Order Details\n                </h2>\n                <dl className=\"space-y-4\">\n                  {orderDetails.customer_name && (\n                    <div>\n                      <dt className=\"text-sm font-medium text-gray-500 dark:text-gray-400\">\n                        Customer Name\n                      </dt>\n                      <dd className=\"mt-1 text-sm text-gray-900 dark:text-white\">\n                        {orderDetails.customer_name}\n                      </dd>\n                    </div>\n                  )}\n                  {orderDetails.order_items && orderDetails.order_items.length > 0 && (\n                    <div>\n                      <dt className=\"text-sm font-medium text-gray-500 dark:text-gray-400\">\n                        Order Items\n                      </dt>\n                      <dd className=\"mt-1 text-sm text-gray-900 dark:text-white\">\n                        <ul className=\"list-disc list-inside space-y-1\">\n                          {orderDetails.order_items.map((item, index) => (\n                            <li key={index}>\n                              {item.quantity}x {item.name}\n                              {item.price && ` - £${item.price.toFixed(2)}`}\n                            </li>\n                          ))}\n                        </ul>\n                      </dd>\n                    </div>\n                  )}\n                  {orderDetails.total_amount && (\n                    <div>\n                      <dt className=\"text-sm font-medium text-gray-500 dark:text-gray-400\">\n                        Total Amount\n                      </dt>\n                      <dd className=\"mt-1 text-sm font-semibold text-gray-900 dark:text-white\">\n                        £{orderDetails.total_amount.toFixed(2)}\n                      </dd>\n                    </div>\n                  )}\n                  {orderDetails.notes && (\n                    <div>\n                      <dt className=\"text-sm font-medium text-gray-500 dark:text-gray-400\">\n                        Notes\n                      </dt>\n                      <dd className=\"mt-1 text-sm text-gray-900 dark:text-white\">\n                        {orderDetails.notes}\n                      </dd>\n                    </div>\n                  )}\n                </dl>\n              </div>\n            )}\n          </div>\n\n          {/* Right Column - Transcript */}\n          <div className=\"lg:col-span-2\">\n            <div className=\"bg-white dark:bg-gray-800 rounded-lg shadow-md p-6\">\n              <h2 className=\"text-lg font-semibold text-gray-900 dark:text-white mb-4\">\n                Conversation Transcript\n              </h2>\n\n              {transcriptSegments.length === 0 ? (\n                <div className=\"text-center py-12\">\n                  <svg\n                    className=\"mx-auto h-12 w-12 text-gray-400\"\n                    fill=\"none\"\n                    stroke=\"currentColor\"\n                    viewBox=\"0 0 24 24\"\n                  >\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      strokeWidth={2}\n                      d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\"\n                    />\n                  </svg>\n                  <p className=\"mt-4 text-sm text-gray-500 dark:text-gray-400\">\n                    No transcript available for this call\n                  </p>\n                </div>\n              ) : (\n                <div className=\"space-y-4 max-h-[600px] overflow-y-auto pr-2\">\n                  {transcriptSegments.map((segment, index) => (\n                    <TranscriptMessage\n                      key={`${segment.speaker}-${index}`}\n                      segment={segment}\n                    />\n                  ))}\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================================================\n// Helper Components\n// ============================================================================\n\n/**\n * Status Badge Props\n */\ninterface StatusBadgeProps {\n  status: string;\n}\n\n/**\n * Status Badge Component\n *\n * Displays a colored badge for call status.\n *\n * @param props - Status badge props\n * @returns Status badge JSX\n */\nfunction StatusBadge({ status }: StatusBadgeProps) {\n  const statusColors: Record<string, string> = {\n    completed: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400',\n    missed: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400',\n    failed: 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400',\n    in_progress: 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400',\n    cancelled: 'bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-400',\n  };\n\n  const badgeClass = statusColors[status] || statusColors.cancelled;\n\n  return (\n    <span className={`px-3 py-1 text-xs font-medium rounded-full ${badgeClass}`}>\n      {status.replace('_', ' ')}\n    </span>\n  );\n}\n\n/**\n * Transcript Message Props\n */\ninterface TranscriptMessageProps {\n  segment: TranscriptSegment;\n}\n\n/**\n * Transcript Message Component\n *\n * Displays a single message in the transcript with speaker label and text.\n *\n * @param props - Transcript message props\n * @returns Transcript message JSX\n */\nfunction TranscriptMessage({ segment }: TranscriptMessageProps) {\n  const isAgent = segment.speaker === 'agent';\n\n  return (\n    <div\n      className={`flex ${isAgent ? 'justify-start' : 'justify-end'}`}\n    >\n      <div\n        className={`max-w-[80%] rounded-lg px-4 py-3 ${\n          isAgent\n            ? 'bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white'\n            : 'bg-blue-50 dark:bg-blue-900/20 text-gray-900 dark:text-white'\n        }`}\n      >\n        <div className=\"flex items-center gap-2 mb-1\">\n          <span className=\"text-xs font-semibold uppercase\">\n            {isAgent ? 'Agent' : 'Customer'}\n          </span>\n          {segment.timestamp && (\n            <span className=\"text-xs text-gray-500 dark:text-gray-400\">\n              {formatTimestamp(segment.timestamp)}\n            </span>\n          )}\n        </div>\n        <p className=\"text-sm whitespace-pre-wrap break-words\">\n          {segment.text}\n        </p>\n      </div>\n    </div>\n  );\n}\n\n// ============================================================================\n// Utility Functions\n// ============================================================================\n\n/**\n * Format date and time for display\n *\n * @param dateString - ISO date string\n * @returns Formatted date and time\n */\nfunction formatDateTime(dateString: string): string {\n  const date = new Date(dateString);\n  const formattedDate = date.toLocaleDateString('en-GB', {\n    day: 'numeric',\n    month: 'long',\n    year: 'numeric',\n  });\n  const formattedTime = date.toLocaleTimeString('en-GB', {\n    hour: '2-digit',\n    minute: '2-digit',\n  });\n  return `${formattedDate} at ${formattedTime}`;\n}\n\n/**\n * Format duration in seconds to human-readable format\n *\n * @param seconds - Duration in seconds\n * @returns Formatted duration (e.g., \"5m 30s\")\n */\nfunction formatDuration(seconds: number): string {\n  const minutes = Math.floor(seconds / 60);\n  const remainingSeconds = seconds % 60;\n  return `${minutes}m ${remainingSeconds}s`;\n}\n\n/**\n * Format timestamp from transcript\n *\n * @param timestampString - ISO timestamp string\n * @returns Formatted time\n */\nfunction formatTimestamp(timestampString: string): string {\n  const date = new Date(timestampString);\n  return date.toLocaleTimeString('en-GB', {\n    hour: '2-digit',\n    minute: '2-digit',\n    second: '2-digit',\n  });\n}\n\n/**\n * Parse transcript text into segments with speaker labels\n *\n * Attempts to parse transcript format like:\n * \"Agent: Hello\\nCustomer: Hi there\"\n *\n * @param transcript - Full transcript text\n * @returns Parsed transcript segments\n */\nfunction parseTranscript(transcript: string): TranscriptSegment[] {\n  const segments: TranscriptSegment[] = [];\n\n  // Split by lines and try to identify speaker labels\n  const lines = transcript.split('\\n');\n  let currentSpeaker: 'agent' | 'customer' | null = null;\n  let currentText = '';\n\n  for (const line of lines) {\n    const trimmedLine = line.trim();\n\n    // Check if line starts with speaker label\n    const agentMatch = trimmedLine.match(/^(Agent:|AI:|Bot:)/i);\n    const customerMatch = trimmedLine.match(/^(Customer:|User:|Caller:)/i);\n\n    if (agentMatch) {\n      // Save previous segment if exists\n      if (currentSpeaker && currentText) {\n        segments.push({\n          speaker: currentSpeaker,\n          text: currentText.trim(),\n        });\n      }\n      currentSpeaker = 'agent';\n      currentText = trimmedLine.substring(agentMatch[0].length).trim();\n    } else if (customerMatch) {\n      // Save previous segment if exists\n      if (currentSpeaker && currentText) {\n        segments.push({\n          speaker: currentSpeaker,\n          text: currentText.trim(),\n        });\n      }\n      currentSpeaker = 'customer';\n      currentText = trimmedLine.substring(customerMatch[0].length).trim();\n    } else if (currentSpeaker) {\n      // Continue current speaker's message\n      currentText += '\\n' + trimmedLine;\n    } else {\n      // No speaker identified yet, treat as agent\n      currentSpeaker = 'agent';\n      currentText = trimmedLine;\n    }\n  }\n\n  // Add last segment\n  if (currentSpeaker && currentText) {\n    segments.push({\n      speaker: currentSpeaker,\n      text: currentText.trim(),\n    });\n  }\n\n  // If no segments were created, treat entire transcript as agent\n  if (segments.length === 0 && transcript) {\n    segments.push({\n      speaker: 'agent',\n      text: transcript,\n    });\n  }\n\n  return segments;\n}\n